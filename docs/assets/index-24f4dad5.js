/* empty css             *//* empty css                     *//* empty css                     *//* empty css                  *//* empty css                  *//* empty css                  */import{l as re}from"./localforage-92bfdfe0.js";import{c as Y}from"./index-74bd6ac0.js";import{r as j,u as de,a as ue,b as pe,c as fe,o as he,d as L,e as w,f as g,w as b,F as q,g as G,h as ge,i as me,E as _e,j as ve,k as ye,l as xe,m as R,n as Q,t as be,p as we,q as Ce,s as Se,v as Ve,x as ke,y as Oe,z as De,A as Ee,B as Ie}from"./index-763031f0.js";const T=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];function Te(_){let e="",n=_;for(;n>=T.length;)n/=T.length,n-=1,e+=T[parseInt(n,10)%T.length];const s=_%T.length;return e+=T[s],e}function Ae(_){let e=0;for(let n=0;n<_.length-1;n+=1){const s=_.charCodeAt(n)-65,c=_.length-1-n;e+=T.length**c+T.length*s}return e+=_.charCodeAt(_.length-1)-65,e}function K(_){let e="",n="";for(let s=0;s<_.length;s+=1)_.charAt(s)>="0"&&_.charAt(s)<="9"?n+=_.charAt(s):e+=_.charAt(s);return[Ae(e),parseInt(n,10)-1]}function Z(_,e){return`${Te(_)}${e+1}`}class B{constructor(e,n,s,c,a=0,d=0){this.sri=e,this.sci=n,this.eri=s,this.eci=c,this.w=a,this.h=d}set(e,n,s,c){this.sri=e,this.sci=n,this.eri=s,this.eci=c}multiple(){return this.eri-this.sri>0||this.eci-this.sci>0}includes(...e){let[n,s]=[0,0];e.length===1?[s,n]=K(e[0]):e.length===2&&([n,s]=e);const{sri:c,sci:a,eri:d,eci:m}=this;return c<=n&&n<=d&&a<=s&&s<=m}each(e,n=()=>!0){const{sri:s,sci:c,eri:a,eci:d}=this;for(let m=s;m<=a;m+=1)if(n(m))for(let k=c;k<=d;k+=1)e(m,k)}contains(e){return this.sri<=e.sri&&this.sci<=e.sci&&this.eri>=e.eri&&this.eci>=e.eci}within(e){return this.sri>=e.sri&&this.sci>=e.sci&&this.eri<=e.eri&&this.eci<=e.eci}disjoint(e){return this.sri>e.eri||this.sci>e.eci||e.sri>this.eri||e.sci>this.eci}intersects(e){return this.sri<=e.eri&&this.sci<=e.eci&&e.sri<=this.eri&&e.sci<=this.eci}union(e){const{sri:n,sci:s,eri:c,eci:a}=this;return new B(e.sri<n?e.sri:n,e.sci<s?e.sci:s,e.eri>c?e.eri:c,e.eci>a?e.eci:a)}difference(e){const n=[],s=(F,z,H,P)=>{n.push(new B(F,z,H,P))},{sri:c,sci:a,eri:d,eci:m}=this,k=e.sri-c,f=e.sci-a,E=d-e.eri,A=m-e.eci;return k>0?(s(c,a,e.sri-1,m),E>0?(s(e.eri+1,a,d,m),f>0&&s(e.sri,a,e.eri,e.sci-1),A>0&&s(e.sri,e.eci+1,e.eri,m)):(f>0&&s(e.sri,a,d,e.sci-1),A>0&&s(e.sri,e.eci+1,d,m))):E>0&&(s(e.eri+1,a,d,m),f>0&&s(c,a,e.eri,e.sci-1),A>0&&s(c,e.eci+1,e.eri,m)),f>0?(s(c,a,d,e.sci-1),A>0?(s(c,e.eri+1,d,m),k>0&&s(c,e.sci,e.sri-1,e.eci),E>0&&s(e.sri+1,e.sci,d,e.eci)):(k>0&&s(c,e.sci,e.sri-1,m),E>0&&s(e.sri+1,e.sci,d,m))):A>0&&(s(d,e.eci+1,d,m),k>0&&s(c,a,e.sri-1,e.eci),E>0&&s(e.eri+1,a,d,e.eci)),n}size(){return[this.eri-this.sri+1,this.eci-this.sci+1]}toString(){const{sri:e,sci:n,eri:s,eci:c}=this;let a=Z(n,e);return this.multiple()&&(a=`${a}:${Z(c,s)}`),a}clone(){const{sri:e,sci:n,eri:s,eci:c,w:a,h:d}=this;return new B(e,n,s,c,a,d)}equals(e){return this.eri===e.eri&&this.eci===e.eci&&this.sri===e.sri&&this.sci===e.sci}static valueOf(e){const n=e.split(":"),[s,c]=K(n[0]);let[a,d]=[c,s];return n.length>1&&([d,a]=K(n[1])),new B(c,s,a,d)}}const Re={class:"xs-container"},Ne={class:"xs-container-left"},$e={class:"com-header"},Be=w("span",null,"返回",-1),We={class:"container-sidebar"},Je={class:"form-item"},je=w("span",null,"报表名称",-1),Le={class:"form-item"},Ue=w("span",null,"数据集",-1),Fe={class:"form-item"},ze=w("span",null,"数据集字段",-1),He={class:"qreport-list"},Pe=["onDragstart"],qe=w("div",{id:"xSpreadSheet",style:{width:"100%",height:"100%"}},null,-1),Ge=[qe],Ke={class:"xs-container-right"},lt={__name:"index",setup(_){const e=j("basic"),n=de(),s=ue(),c=Y.reportList.find(i=>i.id===n.params.id),a=j(c),d=j(Y.datasetList),m=pe({datasetFields:[]}),k=j([{value:"no",label:"不分组"},{value:"group",label:"向下分组"},{value:"groupRight",label:"向右分组"}]),f=j({text:"",ri:0,ci:0,width:null,height:null,groupType:"no",dynamicWidth:!1,computed:""}),E=fe(()=>{const{ri:i,ci:t}=f.value;return`${i},${t}`}),A=i=>{const{dataset:t,ri:o,ci:r}=f.value;if(t){const p=`#{test.computed(${i})}`;f.value.text=p,u.sheet.data.setCellText(o,r,p,"finished"),u.reRender()}},F=i=>{u.sheet.data.setSelectedCellText(i),u.reRender()},z=i=>{u.sheet.data.setColWidth(f.value.ci,+i),u.reRender()},H=i=>{u.sheet.data.setRowHeight(f.value.ri,+i),u.reRender()},P=(i,t,o)=>{let r="";switch(o){case"no":r=`#{${i}.${t}}`;break;case"group":r=`#{${i}.group(${t})}`;break;case"groupRight":r=`#{${i}.groupRight(${t})}`;break}return r},ee=i=>{const t=u.sheet.data.getSelectedCell(),{dataset:o,field:r}=t;t.groupType=i,o&&r&&(t.text=P(o,r,i)),u.reRender(),U()},te=i=>{const t=u.sheet.data.getSelectedCell();t.dynamicWidth=i,u.reRender(),U()},se=(i,t)=>{i.dataTransfer.setData("data",JSON.stringify(t))},ie=i=>{const t=i.dataTransfer.getData("data"),{dataset:o,field:r}=JSON.parse(t),p=`#{${o}.${r}}`,{ri:y,ci:O}=u.sheet.data.selector;u.sheet.data.setCellText(y,O,p,"finished");const I=u.sheet.data.getCell(y,O);I.dataset=o,I.field=r,I.groupType="no",I.dynamicWidth=!1,u.reRender(),U()},U=()=>{let i=u.sheet.data.getSelectedCell()||{};const{ri:t,ci:o}=u.sheet.data.selector,{width:r,height:p}=u.sheet.data.getSelectedRect();f.value={...i,ri:t,ci:o,width:r,height:p}},le=()=>{const i=u.sheet.data.getData();Object.assign(i,X),a.value.data=JSON.stringify(i);const{rows:t}=i,o={dataset:"",cellConfigList:[]},r={};let p=-1;if(Object.keys(t).forEach(h=>{const C=t[h],{cells:V}=C;V&&(console.log(111,V),Object.keys(V).forEach(D=>{const x=V[D];let{text:v,dataset:l,field:S,groupType:W}=x;if(v&&v.startsWith("#{")){p=+h,v=v.replaceAll(" ","");const N=v.slice(2,v.length-1),$=N.split(".");if($[1].startsWith("group(")){let J=$[1].slice(6,$[1].length-1);o.group=!0,o.cellConfigList.push({key:J,group:!0,...x})}else{o.group=!1;const J=N.split(".");o.dataset=J[0],o.dataKey=J[1],o.cellConfigList.push({key:J[1],group:!1,...x})}}}))}),console.log(9393,o),p>-1)for(let h=0;h<p;h++)r[h]=t[h];const y=d.value.find(h=>h.key===o.dataset);let O="";if(y){const h=JSON.parse(y.data);if(Array.isArray(h)){let C=[];h.forEach((x,v)=>{const l={},S=p+v;o.cellConfigList.forEach((W,N)=>{const $=x[W.key];l[N]={...W,text:$},W.group&&(S===p?C.push({rowIndex:S,cellIndex:N,rowCount:1}):h[v-1][W.key]===$?C.at(-1).rowCount++:C.push({rowIndex:S,cellIndex:N,rowCount:1}))}),Reflect.set(r,S,{cells:l})}),C=C.filter(x=>x.rowCount>1);const V=C.map(x=>{const{rowIndex:v,cellIndex:l,rowCount:S}=x;return r[v].cells[l].merge=[S-1,0],new B(v,l,v+S,l).toString()}),D=JSON.parse(JSON.stringify(i));D.rows=r,D.merges=D.merges.concat(V),O=JSON.stringify(D)}else{const C=JSON.parse(JSON.stringify(i)),{rows:V}=C;Object.keys(V).forEach(D=>{const x=V[D];x.cells&&Object.keys(x.cells).forEach(v=>{const l=x.cells[v],S=ne(l);S&&S.dataset===y.key&&(l.text=h[S.dataKey]||"")})}),O=JSON.stringify(C)}}else O=JSON.stringify(i);const I="previewData";re.setItem(I,O),s.push(`/preview/${a.value.id}`)},ne=i=>{let t=i.text;const o={dataset:"",cellConfigList:[]};if(t&&t.startsWith("#{")){t=t.replaceAll(" ","");const r=t.slice(2,t.length-1),p=r.split(".");if(p[1].startsWith("group(")){let y=p[1].slice(6,p[1].length-1);o.group=!0,o.cellConfigList.push({key:y,group:!0,...i})}else{o.group=!1;const y=r.split(".");o.dataset=y[0],o.dataKey=y[1],o.cellConfigList.push({key:y[1],group:!1,...i})}}return o},ae=i=>{const{clientX:t,clientY:o}=i,{ri:r,ci:p}=u.sheet.data.getCellRectByXY(t-220,o-40);u.sheet.selector.set(r,p,!0),i.preventDefault()},oe=()=>{M()},M=()=>{const i=d.value.find(t=>t.id===a.value.datasetId);if(i){const t=JSON.parse(i.data),o=Array.isArray(t)?t.length?t[0]:{}:t;m.datasetFields=Object.keys(o).map(r=>({field:r,dataset:i.key}))}else m.datasetFields=[]},ce=()=>{s.push("/list")};let u=null;const X={row:{len:100,height:25},col:{len:26,width:100,minWidth:10}};return he(()=>{M();const i={mode:"edit",showToolbar:!0,showBottomBar:!1,showGrid:!0,showContextmenu:!0,view:{height:()=>document.getElementById("xSpreadSheet").clientHeight,width:()=>document.getElementById("xSpreadSheet").clientWidth},...X,style:{bgcolor:"#ffffff",align:"left",valign:"middle",textwrap:!1,strike:!1,underline:!1,color:"#0a0a0a",font:{name:"Helvetica",size:10,bold:!1,italic:!1}}};x_spreadsheet.locale("zh-cn",x_spreadsheet.$messages["zh-cn"]);const t=JSON.parse(a.value.data);u=new x_spreadsheet("#xSpreadSheet",i).loadData(t),u.reRender(),u.on("cell-selected",(o,r,p)=>{U()}),window.xsInstance=u}),(i,t)=>{const o=me("Back"),r=_e,p=ve,y=Se,O=ye,I=Ve,h=ke,C=Oe,V=De,D=Ee,x=Ie,v=xe;return R(),L("div",Re,[w("div",Ne,[w("div",$e,[w("div",{class:"back-wrap",onClick:ce},[g(r,null,{default:b(()=>[g(o)]),_:1}),Be])]),w("div",We,[w("div",Je,[je,g(p,{modelValue:a.value.name,"onUpdate:modelValue":t[0]||(t[0]=l=>a.value.name=l)},null,8,["modelValue"])]),w("div",Le,[Ue,g(O,{modelValue:a.value.datasetId,"onUpdate:modelValue":t[1]||(t[1]=l=>a.value.datasetId=l),placeholder:"请选择",filterable:"",onChange:oe},{default:b(()=>[(R(!0),L(q,null,G(d.value,l=>(R(),Q(y,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),w("div",Fe,[ze,w("div",He,[(R(!0),L(q,null,G(ge(m).datasetFields,l=>(R(),L("div",{class:"list-item",draggable:"true",onDragstart:S=>se(S,l)},be(l.field),41,Pe))),256))])])])]),w("div",{class:"xs-container-middle",onDrop:ie,onDragover:ae},Ge,32),w("div",Ke,[g(v,{modelValue:e.value,"onUpdate:modelValue":t[9]||(t[9]=l=>e.value=l)},{default:b(()=>[g(x,{label:"基本",name:"basic"},{default:b(()=>[g(D,{"label-position":"left","label-width":"64px",style:{padding:"0 12px"}},{default:b(()=>[g(h,{label:"动作"},{default:b(()=>[g(I,{onClick:le},{default:b(()=>[we("预览")]),_:1})]),_:1}),g(h,{label:"坐标"},{default:b(()=>[g(p,{modelValue:E.value,"onUpdate:modelValue":t[2]||(t[2]=l=>E.value=l),disabled:""},null,8,["modelValue"])]),_:1}),g(h,{label:"值"},{default:b(()=>[g(p,{modelValue:f.value.text,"onUpdate:modelValue":t[3]||(t[3]=l=>f.value.text=l),onInput:F,placeholder:"请输入值"},null,8,["modelValue"])]),_:1}),g(h,{label:"宽度"},{default:b(()=>[g(C,{modelValue:f.value.width,"onUpdate:modelValue":t[4]||(t[4]=l=>f.value.width=l),"controls-position":"right",onChange:z,placeholder:"请输入宽度"},null,8,["modelValue"])]),_:1}),g(h,{label:"高度"},{default:b(()=>[g(C,{modelValue:f.value.height,"onUpdate:modelValue":t[5]||(t[5]=l=>f.value.height=l),"controls-position":"right",onChange:H,placeholder:"请输入高度"},null,8,["modelValue"])]),_:1}),g(h,{label:"分组类型"},{default:b(()=>[g(O,{modelValue:f.value.groupType,"onUpdate:modelValue":t[6]||(t[6]=l=>f.value.groupType=l),placeholder:"Select",onChange:ee},{default:b(()=>[(R(!0),L(q,null,G(k.value,l=>(R(),Q(y,Ce({key:l.value,ref_for:!0},l),null,16))),128))]),_:1},8,["modelValue"])]),_:1}),g(h,{label:"动态宽度"},{default:b(()=>[g(V,{modelValue:f.value.dynamicWidth,"onUpdate:modelValue":t[7]||(t[7]=l=>f.value.dynamicWidth=l),onChange:te},null,8,["modelValue"])]),_:1}),g(h,{label:"计算属性"},{default:b(()=>[g(p,{modelValue:f.value.computed,"onUpdate:modelValue":t[8]||(t[8]=l=>f.value.computed=l),onInput:A,placeholder:"请输入值"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])])}}};export{lt as default};
